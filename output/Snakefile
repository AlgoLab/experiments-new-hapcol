import os.path

#
# for testing and comparing the new hapcol
#----------------------------------------------------------------------

root_dir = '/data/experiments-new-hapcol/'

# utils
pjoin = os.path.join
def base_path(*argv):
        return os.path.join(root_dir, *argv)

# dirs
prog_dir = base_path('programs')
wif_dir = base_path('input_wif')
merged_dir = base_path('merged_wif')
out_dir = base_path('output')

# hapcol
hapcol = pjoin(prog_dir, "increase-k-hapcol", "build", "hapcol")

# datasets
datasets = ['ashk', 'sim']
individuals = ['child'] # mother, father, ..
chromosomes = [21] #, 1]
coverages = [5, 10, 15] #, 20, 25, 30, 'all']
seeds = [1] #, 2, 3]
max_covs = [20, 30]

ea_vals=['05_1', '05_01', '05_001', '05_0001'] 
# "01_1" "01_01" "01_001" "01_0001" "1_1" "1_01" "1_001" "1_0001")


datasets_exp = ['{}.pacbio.{}.chr{}.cov{}'.format(dataset, individual, chromosome, coverage)
	for dataset in datasets
	for individual in individuals
	for chromosome in chromosomes
	for coverage in coverages]

# master rule
rule all :
	input :
		expand(pjoin(out_dir, 'inck', '{paths}.shuf{seed}.max{max}.{ea}.out_hc'),
			paths = datasets_exp,
			seed = seeds,
                        max = max_covs,
                        ea = ea_vals
                     ),
		expand(pjoin(out_dir, 'inck-merged', '{paths}.shuf{seed}.max{max}.merged.{ea}.out_hc'),
			paths = datasets_exp,
			seed = seeds,
                        max = max_covs,
                        ea = ea_vals
                     )

rule inck_hapcol:
	input:
		wif_file = pjoin(wif_dir, '{paths}.shuf{seed}.max{max}.wif')
	output:
		out_dir = pjoin(out_dir, 'inck'),
		out_file = pjoin(out_dir, 'inck', '{paths}.shuf{seed}.max{max}.{ea}.out_hc')
	threads:
		1
	params:
		e = lambda wildcards : '0.' + str(wildcards.ea).split('_')[0],
		a = lambda wildcards : '0.' + str(wildcards.ea).split('_')[1]
	log:
		pjoin(out_dir, 'inck', '{paths}.shuf{seed}.max{max}.{ea}.log_hc')
	shell:
                "(" +
                "mkdir -p {output.out_dir}" +
                " && " +
                "/usr/bin/time -v " +
		hapcol + " " +
		"-i {input.wif_file} " +
		"-o {output.out_file} " +
		"-e {params.e} " +
		"-a {params.a} " +
		"-A " +
		"&> {log}; " +
                ")"

rule inck_hapcol_merged:
	input:
		wif_file = pjoin(merged_dir, '{paths}.shuf{seed}.max{max}.merged.wif')
	output:
		out_dir = pjoin(out_dir, 'inck-merged'),
		out_file = pjoin(out_dir, 'inck-merged', '{paths}.shuf{seed}.max{max}.merged.{ea}.out_hc')
	threads:
		1
	params:
		e = lambda wildcards : '0.' + str(wildcards.ea).split('_')[0],
		a = lambda wildcards : '0.' + str(wildcards.ea).split('_')[1]
	log:
		pjoin(out_dir, 'inck-merged', '{paths}.shuf{seed}.max{max}.merged.{ea}.log_hc')
	shell:
                "(" +
                "mkdir -p {output.out_dir}" +
                " && " +
                "/usr/bin/time -v " +
		hapcol + " " +
		"-i {input.wif_file} " +
		"-o {output.out_file} " +
		"-e {params.e} " +
		"-a {params.a} " +
		"-A " +
		"&> {log}; " +
                ")"
